## 网络层概述

网络层的主要任务就是将分组从源主机经过多个网络和多段链路传输到目的主机，可以将该任务划分为分组转发和路由选择两种重要的功能，向上提供面向连接的虚电路服务，无连接的数据报服务。

位于OSI体系结构的第三层。

### 分组转发

当路由器收到某个接口所连接的链路上收到一个分组之后，将分组从自己其他适当的接口转发给下一跳路由器或者目的主机。

每个路由器会构建一个路由表，在此基础上维护成一个转发表，根据分组首部的转发标识在转发表中查询。

### 路由选择

源主机和目的主机之间存在多条路径，网络层需要决定选择哪一条路径来传送分组。

一般分为：

1. 集中式路由选择，由某个网路控制中心执行路由选择。
2. 分布式路由选择，在每个路由器上运行路由选择协议，各路由器相互交换路由信息并各自计算路由。
3. 人工路由选择，网络维护人员配置路由。

### 虚电路服务

<img src="http://pic.shixiaocaia.fun/202210180929190.png" alt="image-20221018092941879" style="zoom:50%;" />

> 1. 核心思想是“可靠通信应由网络自身来保证”。
> 2. 必须首先建立网络层连接一虚电路，以保证通信双方所需的一切网络资源。是一条逻辑链路。
> 3. 通信双方沿着已建立的虚电路发送分组。
> 4. 这种通信方式如果再使用可靠传输的网络协议，就可使所发送的分组最终正确（无差错按序到达、不丢失、不重复）到达接收方。

### 无连接的数据报服务

<img src="http://pic.shixiaocaia.fun/202210180949041.png" alt="image-20221018094911308" style="zoom:50%;" />

> 1. 核心思想是 可靠通信应由用户主机来保证
> 2. 不需要建立网络层连接
> 3. **每个分组可走不同的路径 因此，每个分组的首部都必须携带目的主机的完整地址。**
> 4. 通信结束后，没有需要释放的连接

由于网络自身不提供端到端的可靠传输服务，这就使得网络中的路由器可以做得比较简单，大大降低了网络造价。

## 网际协议（IP）

网际协议（Internet Protocol，IP）是TCP/IP体系结构网际层中的核心协议。

要将众多的异构型网络都互连起来，并且能够互相通信，则会面临许多需要解决的问题。

- 不同的网络接入机制
- 不同的差错恢复方法
- 不同的路由选择技术
- 不同的寻址方案
- 不同的最大分组长度
- 不同的服务（面向连接服务和无连接服务）

### IPv4地址的划分

IPv4地址是给因特网（Internet）上的每一个主机（或路由器）的每一个接口分配的一个在全世界范围内唯一的32比特的标识符。

> 网络号：标志主机（或路由器）的接口所连接到的网络
>
> 主机号：标志主机（或路由器）的接口

<img src="http://pic.shixiaocaia.fun/202210191437450.png" alt="image-20221019143705261" style="zoom:50%;" />

<img src="http://pic.shixiaocaia.fun/202210191438884.png" alt="image-20221019143809984" style="zoom:50%;" />

<img src="http://pic.shixiaocaia.fun/202210191440508.png" alt="image-20221019144013101" style="zoom:50%;" />

> A类地址的，127，0网络号保留，不可分配。
>
> ABC地址的，主机号全0作为网络地址，全1作为广播地址。

### 分类编址

上述的最一开始的，划分网络号，然后再分配主机号，造成了大量的IPv4地址浪费。比如一个C类网络号，最多可以分配地址254个，不足以给256个主机分配，得分配一个B类网络号，然后B类网络号使用又绰绰有余。

### 划分子网

可以将多余的主机号选出一部分作为子网号，这样我分配一个B类网络号后，可以划分子网，来给公司的不同局域网分配网络号，而不用重新申请一个新的网络号。

子网掩码可以表明分类IPv4地址的主机号部分被借用了几个比特作为子网号。用左起多个连续的比特1对应IPv4地址中的网络号和子网号，后面连续的0作为主机号。

### 无分类编址

尽管用划分子网的方法缓解了一部分浪费，但是C类网络中主机号过小还是造成了极大的浪费。

因此有了无分类域间路由选择（Classless Inter-Domain Routing，CIDR ）。

CIDR将地址划分为网络前缀，主机号，但是网络前缀不定长，配合子网掩码可以得到网络前缀和子网号的长度区别。

**路由聚合**

通过无分类编址方式，在同一个局域网下面，路由器的路由表可以利用CIDR地址块来查找目的地址。

可以找到最长的公共前缀，得到聚合后的CIDR地址块，这样得到的地址块更小，路由更加具体。

**子网掩码划分**

有利于子网的划分，避免地址的浪费。

### IPv4地址和MAC地址

**封装的位置**

<img src="http://pic.shixiaocaia.fun/202210201449678.png" alt="image-20221020144911905" style="zoom:50%;" />

> IP地址是由网际层及其以上各层使用的地址，而MAC地址是数据链路层使用的地址。
>
> 源IP地址和目的IP地址被封装在IP数据包的首部，源MAC地址和目的MAC地址被封装在帧的首部。

**数据报传送过程中IPv4地址与MAC地址的变化情况**

<img src="http://pic.shixiaocaia.fun/202210201453178.png" alt="image-20221020145323362" style="zoom:50%;" />

> 始终以IP地址作为网络中发送接受路径判断的方向标。
>
> 如果仅仅使用MAC地址进行通信，必须考虑以下问题：
>
> 1. 每台路由器的路由表必须记录因特网上所有主机和路由器各个接口的MAC地址。
> 2. 手动给各个路由配置路由表不可能，通过相互交换路由信息，由于MAC接口的数量巨大，从而会占用大量的资源。
> 3. 不同设备的MAC地址不同，也会造成极大的解析任务。

实际当中，我们使用IP地址进行寻址，只需要记录部分网络的IP地址，路由器收到IP数据报后，基于路由表进行转发，不用记录大量的MAC地址。

当同时也要考虑如何根据IP地址，寻找对应的MAC地址，否则数据帧无法进行封装。

### 地址解析协议 ARP

每一台主机会维护一个ARP高速缓存表，记录有IP地址对应的MAC地址对应关系。每一条记录分为动态类型和静态类型。

> 动态类型：是主机通过ARP协议自动获取的，有一定的生命周期，因为IP地址和MAC地址的对应关系会改变。
>
> 静态类型：用户或者网络维护人员手工配置的，生命周期也相应不同，重启后仍有效。

当路由表没有查到相应的对应关系时：

> 1. 主机会发送ARP请求报文获取MAC地址。（被封装在MAC帧中发送，这样可以使用广播地址FF-FF-FF-FF-FF-FF发送）
> 2. 其他总线上的（同一个局域网），主机收到后解析ARP请求报文，不是自己的IP地址时就丢弃
> 3. 当发现是查找自己的IP地址时，首先将请求方的IP地址和MAC地址关系记录到自己的ARP高速缓存表当中。然后发送响应报文，理论是发送单播帧，但是由于总线天然的广播特性，会群发。
> 4. 各个主机收到后判断是不是自己需要的。

注意：ARP协议时解决同一个局域网上的设备IP地址和MAC地址映射问题。且ARP协议可能会有一些网络安全问题，没有相应的安全验证机制。

### IP数据包的发送和转发过程

<img src="http://pic.shixiaocaia.fun/202210211406407.png" alt="image-20221021140631281" style="zoom:50%;" />

如上图一个小型的互联网的网络拓扑结构。

> 1. 路由器中的0，1两个接口，连接了两个以太网。
> 2. 根据CIDR给两个以太网分配了地址块，也就是网络号。
> 3. 路由器0，1接口的IP地址作为了两个以太网的默认网关。

网关：是一个网络通向其他网络的IP地址。

IP数据包的发送和转发主要包含：主机发送IP数据报，路由器转发IP数据报。

**直接交付**

同一个网络中的主机之间可以直接通信。

源主机通过ARP协议获取到同一网络中的目的主机的MAC地址，就可以把IP数据报封装成帧后发送给目的主机。

> 怎么判断是同一个网络：
>
> 将IP地址与子网掩码相与就得到了所在以太网的网络地址，对比源IP地址和目的IP地址。

**间接交付**

不同网络中的主机之间通信，需要通过默认网关（路由器）来中转。

假设路由器收到了正确的IP数据报，根据IP数据报的首部中的IP地址在自己的路由表中进行查询。

> 查询到了，对应转发。
>
> 查询不到，就丢弃，回发主机错误报告。

简单考虑：

路由器的路由表应该至少包含了所连接网络的路由条目，根据CIDR分配的的路由器接口的IP地址，结合子网掩码，可以推测出接口所连接的网络地址。

IP数据报到达路由器时，通过将目的IP地址与地址掩码相与判断对应的网络地址。

找到对应网络地址的接口进行转发，并且路由器通过ARP协议获取到同一个网络中的目的主机的MAC地址，进行转发。

> 如果路由器收到的是广播地址的IP数据报，不会对其转发，可以用来隔离广播域，避免广播风暴，造成资源浪费。
>
> CIDR方式的广播地址时，主机号全为1。

