## 数据链路层概述

<img src="http://pic.shixiaocaia.fun/202210061705679.png" alt="image-20221006170529420" style="zoom:50%;" />

上图为两台主机通过互联网通信的流程。

> 涉及的概念：
>
> 链路：两个直接相连的节点，比如主机H1到路由器R1。同时这三段链路可能采用不同的协议。
>
> 数据链路：在链路基础上，加上实现必要通信协议来控制数据传输的硬件和软件（比如网卡和其软件），构成了数据链路。
>
> 帧：是数据链路层对等实体之间在水平方向进行逻辑通信的协议数据单元PDU。

## 封装成帧和透明传输

### 封装成帧

在网络层交付下来的分组的基础上添加一个首部和尾部，构成一个帧。

<img src="http://pic.shixiaocaia.fun/202210061718206.png" alt="image-20221006171810194" style="zoom:50%;" />

> 帧首部包含了帧开始符、帧的源地址和目的地址。
>
> 帧尾部包含了帧校验序列和帧结束符。
>
> 接收方根据帧开始和结束符号进行帧定界。

> 在上图中，我们可以看到数据载荷部分，为了提高数据链路层传输帧的效率，应该使帧的数据载荷长度尽可能大于首尾的长度。
>
> 综合考虑其他因素，设置了一个上限，即最大传输单元（Maximum Transfer Unit MTU）。例如上述MTU  = 1500B

### 透明传输

上述的帧封装中，帧开始符和帧结束符可能出现在数据载荷部分，造成帧定界的误判。

考虑帧定界符，有了透明传输这一技术的出现。

> 字节填充：当使用面向字节的物理链路中，在发送方的数据链路层中的数据载荷出现帧定界符的前面插入转义字符“ ESC ”，接收端再去除这些。

> 比特填充：当使用面向比特的物理链路中，针对比特构成的帧定界符加如特定的比特避免形成帧定界符。

## 差错检测FCS

检测在传输过程中，不可避免产生的误码。

 **奇偶校验**

在待发送的数据后面增加一个校验位，使得整个数据中的 “1” 的个数为奇数或者偶数，再对比接收方的个数，判断是否发生误码。

但是发生多为错码时，奇偶性不变，无法检错。

**循环冗余校验CRC**

利用一个收发方规定好的生成多项式，生成冗余码放到待发送的数据后面，接收到后进行检查。更加被广泛运用到数据链路层当中，但是无法具体检测到错在哪些帧和比特。

## 可靠传输

### 可靠传输的基本概念

传输差错包括：误码、分组丢失、分组失序、分组重复等，但是后三者一般出现在数据链路层上层，误码出现在数据链路层及其以下。

> 一般情况下，有线链路的误码率比较低。为了减小开销，并不要求数据链路层向其上层提供可靠传输服务。即使出现了误码，可靠传输的问题由其上层处理。
>
> 无线链路易受干扰，误码率比较高，因此要求数据链路层必须向其上层提供可靠传输服务。

<img src="http://pic.shixiaocaia.fun/202210071440507.png" alt="image-20221007144005538" style="zoom:50%;" />

### 停止等待协议

停止-等待（Stop-and-Wait，SW）。发送方每发送完一个数据分组，必须等接收方发来确认（Acknowledgement , ACK）或者否认（Negative Acknowledgement NAK）分组。

<img src="http://pic.shixiaocaia.fun/202210071507108.png" alt="image-20221007150702542" style="zoom:50%;" />

**信道利用率**

<img src="http://pic.shixiaocaia.fun/202210071511677.png" alt="image-20221007151102295" style="zoom:50%;" />

如果出现超时重传，信道利用率还要再降低。因此收发双发不适用这个协议。

可以采用流水线传输方式，不用等待接收方的确认分组的情况下，连续发送多个数据分组，但是有一定限制，否则来不及处理数据分组。

### 回退N帧协议

回退N帧协议（Go-back-N，GBN）采用流水线传输方式，通过发送串口来限制发送方连续发送数据分组的数量。

<img src="http://pic.shixiaocaia.fun/202210071545628.png" alt="image-20221007154507582" style="zoom:50%;" />

发送方不断发送发送窗口内的数据，接收方正确收到后给发送方发送ACK，ACK收到后又继续滑动窗口。

**超时重传问题**

当出现某一个位置误码时，接收方还在发送目前已经正确接受的ACK，那么出错位置的发送端数据就会超时，对该位置以及后面的数据进行重发。

> 并且这里也可以设置重复收到一个位置ACK多次时判定出错，进行重发，不用等到计时器超时。

**发送窗口和接受窗口尺寸**

<img src="http://pic.shixiaocaia.fun/202210090816899.png" alt="image-20221007162831058" style="zoom:50%;" />

超过范围，可能无法判断是新数据还是旧数据，多出。

我在0，你给我发0是新的一组还是旧的一组呢。

我要是在7，你给我发0，我知道是前面的，回退这一组数据。

### 选择重传协议

将发送方和接收方的长度都大于1，这样我们可以选择错误部分进行重发，保存正确到达接受的部分，并且不发送到上层，等到前面正确的重发后。

> 显然这样做更加复杂，而且要有足够的缓存空间应对出错。

<img src="http://pic.shixiaocaia.fun/202210071642796.png" alt="image-20221007164219085" style="zoom:50%;" />

## 点到点协议

<img src="http://pic.shixiaocaia.fun/202210090932838.png" alt="image-20221009093220820" style="zoom:50%;" />

![image-20221009093330189](http://pic.shixiaocaia.fun/202210090933048.png)

1. 因特网用户计算机使用PPP协议接入ISP。
2. 广域网路由器之间的专用链路。

### PPP协议的组成

<img src="http://pic.shixiaocaia.fun/202210090936850.png" alt="image-20221009093613943" style="zoom:50%;" />

### 帧格式

<img src="http://pic.shixiaocaia.fun/202210090936440.png" alt="image-20221009093642707" style="zoom:50%;" />

<img src="http://pic.shixiaocaia.fun/202210090940478.png" alt="image-20221009094022603" style="zoom:50%;" />

> 零比特填充，对一定连续的0或者1补0/1，避免误判，接收方对连续的0/1进行处理。

### 工作状态

<img src="http://pic.shixiaocaia.fun/202210090943916.png" alt="image-20221009094257508" style="zoom:50%;" />

## 共享以太网

目前发展情况下使用的是交换式以太网，以太网标准目前主要是DIX Ethernet V2，IEEE 802.3由于发布的网，并没有广泛使用。

### 网络适配器（网卡）

要将计算机连接到以太网，需要使用相应的网络适配器（Adapter），网络适配器一般简称为“网卡”。

**网卡的构成**

<img src="http://pic.shixiaocaia.fun/202210091119816.png" alt="image-20221009111944080" style="zoom:50%;" />

![image-20221009112007080](http://pic.shixiaocaia.fun/202210091120060.png)

<img src="http://pic.shixiaocaia.fun/202210091120519.png" alt="image-20221009112022604" style="zoom:50%;" />

### MAC地址

对于连接多个站点的广播信道，要实现两个站点之间的通信，需要一个数据链路层地址作为唯一表示。

在每个主机发送的帧的首部中，都携带有发送主机（源主机）和接收主机（目的主机）的数据链路层地址。由于这类地址是用于媒体接入控制（Medium Access Control，MAC）的，因此被称为MAC地址。

> MAC地址一般被固化在网卡的电可擦可编程只读存储器EEPROM中，因此MAC地址也被称为硬件地址。
>
> MAC又被称为硬件地址、物理地址，但是属于数据链路层。
>
> 一般计算机包含两块网卡，一块用于有线局域网以太网的连接，还有一块无线局域网的WIFI网卡。
>
> 每个网卡都有全球唯一的MAC地址。（对网络设备接口的唯一表示）
>
> 交换机和路由器有更多的网络接口（MAC地址）

**IEEE 802.3 的MAC地址**

规定了第一字节为单播和组播区别，第二字节为全球管理或者本地管理的区别号。

<img src="http://pic.shixiaocaia.fun/202210091157713.png" alt="image-20221009115704502" style="zoom:50%;" />

> 目前为了避免用户设备连接WIFI热点时MAC地址泄露的问题，现在大多数设备采用了随机MAC地址技术。

### CSMA/CD协议

**基本原理**

载波监听多址接入/碰撞检测（Carrier Sense Multiple Access/Collision Detection）。

当某个站点在总线上发送帧时，总线资源会被该站点独占。此时，如果总线上的其他站点也要在总线上发送帧，就会产生信号碰撞。当两个或多个站点同时使用总线发送帧时，就会产生信号碰撞。

**共享总线以太网的一个重要问题：如何协调总线上的各站点争用总线**

<img src="http://pic.shixiaocaia.fun/202210111008195.png" alt="image-20221011100807120" style="zoom:50%;" />

> 为什么发送帧过程中还要CD呢
>
> 因为在共享总线上，A发送的帧，D没收到，D以为还是空闲状态的，D也接着发送帧了。
>
> 由于上述的机制，站点只能进行半双工通信。

**争用期**

共享总线将以太网端到端往返时间的两倍定义为争用期或者叫碰撞窗口。

站点从发送帧开始，经过争用期还没检测到碰撞就不会发生碰撞。

**最小帧长和最大帧长**

<img src="http://pic.shixiaocaia.fun/202210111018854.png" alt="image-20221011101854207" style="zoom:50%;" />

最大帧长除了MTU的限制，也不能尽可能大那样其他主机的等待时间较长，缓冲区可能装不下去。

**退避算法**

退避时间 = 基本退避时间2$\tau$ × 随机数$r$

**信道利用率**

总线越长，信道极限利用率就越低，网络的性能就越差。

总线越长，站点接入越多，越容易发生碰撞，性能进一步降低。

### 使用集线器Hub的共享以太网

早期使用无源的电缆线，需要大量机械接口，一旦某个机械接口出错就会导致断网。

后来发展到用大规模集成电路来替代总线，并且可靠性非常高的设备，叫集线器Hub。

站点连接到集线器的传输媒体也转而使用更便宜、更灵活的双绞线电缆。

<img src="http://pic.shixiaocaia.fun/202210111042427.png" alt="image-20221011104256610" style="zoom:50%;" />

> 集线器的本质逻辑上还是一个总线网，试试在使用CSMA/CD协议。
>
> 只工作在物理层，接口不进行碰撞检测。
>
> 集线器一般都有少量的容错能力和网络管理功能。

### 在物理层扩展以太网

**扩展站点与集线器之间的距离**

1. 通过转发器，任意两个网段之间最多经过三个转发器，随着双绞线和集线器的使用，转发器也被淘汰了。
2. 在10BASE-T星型以太网中，尝试用一对光纤调制解调器，以及他们中间的一对通信光纤来扩展距离。

**扩展共享以太网的覆盖范围和站点的数量**

1. 在**物理层**：通过一个主干集线器将两个网段连接在一起，形成一个更大的网络，但是通过这样的方式连接后，原本两个网络的吞吐量不会合并是独立的，那么相对于原先的独立邻域，合并之后每个站点发生碰撞的可能性大大增加。
2. 在**数据链路层（包含以下的物理层）**，使用网桥拓阔共享以太网，能够避免形成更大的碰撞域。

### 网桥的基本工作原理

> 网桥连接两个不同的共享以太网，每个以太网称为一个网段。

由于共享以太网，一台主机发送帧时，会发送给整个以太网，各个主机根据目的MAC地址来判断是不是发送给自己的，不是则丢弃。

而当网桥收到这样一个帧时，根据查表，如果在一个网段则说明不需要转发直接丢弃，否则转发给网桥的其他端口来寻找。

上述的操作是网桥通过其内部的接口管理软件和网桥协议实体来实现的。

**透明网桥的自学习和转发帧流程**

> 透明网桥是指以太网中各个站点不知道自己会经过哪些网桥的转发，对站点而言不知道网桥的存在。
>
> 透明网桥通过将独立的以太网连接在一起，它是一种即插即用的设备，会通过一种自学习算法基于以太网中各个站点间的相互通信逐步建立起自己的转发表。

> 自学习：当网桥收到一个帧他的目的MAC地址，不在转发表中，会进行“盲目地转发”给其他端口。
>
> 当发现网桥上设备有目的MAC地址时，会进行明确的转发。
>
> 当网桥知道不用转发，就在本网段中时，会丢弃。

注意：

（1）如果网桥收到有误码的帧则直接丢弃。
（2）如果网桥收到一个无误码的广播帧，则不用进行查表，而是直接从除接收该广播帧的接口的其他接口转发该广播帧。
（3）转发表中的每条记录都有其有效时间，到期自动删除！这是因为各站点的MAC地址与网桥接口的对应关系并不是永久性的，例如某个站点更换了网卡，其MAC地址就会改变。

**透明网桥的生成树协议STP**

为了提高以太网的可靠性，有时需要在两个以太网之间使用多个透明网桥来提供冗余链路。

但是这样会形成环路，造成广播帧和单播帧充斥在网络当中，网络资源被浪费，网络中主机无法正常通信，透明网桥使用了生成树协议（Spanning Tree Protocol) STP。

网桥通过交换STP相关数据包，在原网络拓扑图地一个连通子集（生成树），相关网桥会关闭自己接口，以确保不存在环路。

## 交换式以太网

交换式集线器被称为以太网交换机，仅使用交换器而不使用集线器的网络被称为交换式以太网。

> 交换机本质上是多网口的网桥。
>
> 交换机自学习和转发帧的流程与网桥是相同的。
>
> 另外，交换机也使用生成树协议STP，来产生能够连通全网但不产生环路的通信路径。

一般交换机采用**存储转发**，也有采用直通交换的方式，直通交换时延更低，但是未经处理可能直接转发了无效码。

> 当交换机的接口与计算机或交换机连接时，可以工作在全双工方式，并能在自身内部同时连通多对接口，使每一对相互通信的计算机都能像独占传输媒体那样，无碰撞地传输数据，这样就不需要使用CSMA/CD协议了。
>
> 当交换机的接口连接的是集线器时，该接口就只能使用CSMA/CD协议并只能工作在半双工方式。可能产生冲突。

### 对比共享以太网

1. 主机发送单播帧时，使用集线器的共享以太网，单播帧会通过集线器发送给整个网络中的主机，通过MAC地址进行判断。交换式以太网根据目的MAC地址会进行有目的的转发。
2. 主机发送广播帧时，共享以太网通过集线器分发，而交换以太网发现是广播帧后，转发给其他端口，效果相同但是基本原理不相同。
3. 多台主机之间相互通信，共享以太网必然会发生碰撞，而交换式以太网进行存储转发，并且实现了多对接口的高速并行交换，因此不会产生碰撞。
