## 数据链路层概述

![image-20221006170529420](http://pic.shixiaocaia.fun/202210061705679.png)

上图为两台主机通过互联网通信的流程。

> 涉及的概念：
>
> 链路：两个直接相连的节点，比如主机H1到路由器R1。同时这三段链路可能采用不同的协议。
>
> 数据链路：在链路基础上，加上实现必要通信协议来控制数据传输的硬件和软件（比如网卡和其软件），构成了数据链路。
>
> 帧：是数据链路层对等实体之间在水平方向进行逻辑通信的协议数据单元PDU。

## 封装成帧和透明传输

### 封装成帧

在网络层交付下来的分组的基础上添加一个首部和尾部，构成一个帧。

![image-20221006171810194](http://pic.shixiaocaia.fun/202210061718206.png)

> 帧首部包含了帧开始符、帧的源地址和目的地址。
>
> 帧尾部包含了帧校验序列和帧结束符。
>
> 接收方根据帧开始和结束符号进行帧定界。

> 在上图中，我们可以看到数据载荷部分，为了提高数据链路层传输帧的效率，应该使帧的数据载荷长度尽可能大于首尾的长度。
>
> 综合考虑其他因素，设置了一个上限，即最大传输单元（Maximum Transfer Unit MTU）。例如上述MTU  = 1500B

### 透明传输

上述的帧封装中，帧开始符和帧结束符可能出现在数据载荷部分，造成帧定界的误判。

考虑帧定界符，有了透明传输这一技术的出现。

> 字节填充：当使用面向字节的物理链路中，在发送方的数据链路层中的数据载荷出现帧定界符的前面插入转义字符“ ESC ”，接收端再去除这些。

> 比特填充：当使用面向比特的物理链路中，针对比特构成的帧定界符加如特定的比特避免形成帧定界符。

## 差错检测FCS

检测在传输过程中，不可避免产生的误码。

 **奇偶校验**

在待发送的数据后面增加一个校验位，使得整个数据中的 “1” 的个数为奇数或者偶数，再对比接收方的个数，判断是否发生误码。

但是发生多为错码时，奇偶性不变，无法检错。

**循环冗余校验CRC**

利用一个收发方规定好的生成多项式，生成冗余码放到待发送的数据后面，接收到后进行检查。更加被广泛运用到数据链路层当中，但是无法具体检测到错在哪些帧和比特。

## 可靠传输

### 可靠传输的基本概念

传输差错包括：误码、分组丢失、分组失序、分组重复等，但是后三者一般出现在数据链路层上层，误码出现在数据链路层及其以下。

> 一般情况下，有线链路的误码率比较低。为了减小开销，并不要求数据链路层向其上层提供可靠传输服务。即使出现了误码，可靠传输的问题由其上层处理。
>
> 无线链路易受干扰，误码率比较高，因此要求数据链路层必须向其上层提供可靠传输服务。

![image-20221007144005538](http://pic.shixiaocaia.fun/202210071440507.png)

### 停止等待协议

停止-等待（Stop-and-Wait，SW）。发送方每发送完一个数据分组，必须等接收方发来确认（Acknowledgement , ACK）或者否认（Negative Acknowledgement NAK）分组。

![image-20221007150702542](http://pic.shixiaocaia.fun/202210071507108.png)

**信道利用率**

![image-20221007151102295](http://pic.shixiaocaia.fun/202210071511677.png)

如果出现超时重传，信道利用率还要再降低。因此收发双发不适用这个协议。

可以采用流水线传输方式，不用等待接收方的确认分组的情况下，连续发送多个数据分组，但是有一定限制，否则来不及处理数据分组。

### 回退N帧协议

回退N帧协议（Go-back-N，GBN）采用流水线传输方式，通过发送串口来限制发送方连续发送数据分组的数量。

![image-20221007154507582](http://pic.shixiaocaia.fun/202210071545628.png)

发送方不断发送发送窗口内的数据，接收方正确收到后给发送方发送ACK，ACK收到后又继续滑动窗口。

**超时重传问题**

当出现某一个位置误码时，接收方还在发送目前已经正确接受的ACK，那么出错位置的发送端数据就会超时，对该位置以及后面的数据进行重发。

> 并且这里也可以设置重复收到一个位置ACK时判定出错，进行重发，不用等到计时器超时。

**发送窗口和接受窗口尺寸**

![image-20221007162831058](http://pic.shixiaocaia.fun/202210090816899.png)

超过范围，可能无法判断是新数据还是旧数据，多出

我在0，你给我发0是新的一组还是旧的一组呢。

我要是在7，你给我发0，我知道是前面的，回退这一组数据。

### 选择重传协议

将发送方和接收方的长度都大于1，这样我们可以选择错误部分进行重发，保存正确到达接受的部分，并且不发送到上层，等到前面正确的重发后。

> 显然这样做更加复杂，而且要有足够的缓存空间应对出错。

![image-20221007164219085](http://pic.shixiaocaia.fun/202210071642796.png)

## 点到点协议

![image-20221009093220820](http://pic.shixiaocaia.fun/202210090932838.png)

![image-20221009093330189](http://pic.shixiaocaia.fun/202210090933048.png)

1. 因特网用户计算机使用PPP协议接入ISP。
2. 广域网路由器之间的专用链路。

### PPP协议的组成

![image-20221009093613943](http://pic.shixiaocaia.fun/202210090936850.png)

### 帧格式

![image-20221009093642707](http://pic.shixiaocaia.fun/202210090936440.png)

![image-20221009094022603](http://pic.shixiaocaia.fun/202210090940478.png)

> 零比特填充

### 工作状态

![image-20221009094257508](http://pic.shixiaocaia.fun/202210090943916.png)

## 共享以太网

目前发展情况下使用的是交换式以太网，以太网标准目前主要是DIX Ethernet V2，IEEE 802.3由于发布的网，并没有广泛使用。

### 网络适配器（网卡）

要将计算机连接到以太网，需要使用相应的网络适配器（Adapter），网络适配器一般简称为“网卡”。

**网卡的构成**

![image-20221009111944080](http://pic.shixiaocaia.fun/202210091119816.png)

![image-20221009112007080](http://pic.shixiaocaia.fun/202210091120060.png)

![image-20221009112022604](http://pic.shixiaocaia.fun/202210091120519.png)

### MAC地址

对于连接多个站点的广播信道，要实现两个站点之间的通信，需要一个数据链路层地址作为唯一表示。

在每个主机发送的帧的首部中，都携带有发送主机（源主机）和接收主机（目的主机）的数据链路层地址。由于这类地址是用于媒体接入控制（Medium Access Control，MAC）的，因此被称为MAC地址。

> MAC地址一般被固化在网卡的电可擦可编程只读存储器EEPROM中，因此MAC地址也被称为硬件地址。
>
> MAC又被称为硬件地址、物理地址，但是属于数据链路层。
>
> 一般计算机包含两块网卡，一块用于有线局域网以太网的连接，还有一块无线局域网的WIFI网卡。
>
> 每个网卡都有全球唯一的MAC地址。（对网络设备接口的唯一表示）
>
> 交换机和路由器有更多的网络接口（MAC地址）

**IEEE 802.3 的MAC地址**

规定了第一字节为单播和组播区别，第二字节为全球管理或者本地管理的区别号。

![image-20221009115704502](http://pic.shixiaocaia.fun/202210091157713.png)

> 目前为了避免用户设备连接WIFI热点时MAC地址泄露的问题，现在大多数设备采用了随机MAC地址技术。
