## 运输层概述

运输层作为OSI体系结构自下而上的第四层，其主要任务是为相互通信的应用进程提供逻辑通信服务，为运行在不同主机上的应用进程提供直接的逻辑通信服务。

> 上一层网络层提供主机之间的逻辑通信，实现主机到主机。
>
> 然而在计算机网络中实际进行通信的真正实体是位于通信两端主机的进程。

运输层的协议又称为端到端的协议，因为运输层的作用范围是应用进程到应用进程。

运输层向应用层实体屏蔽了下面网络核心的细节（例如网络拓扑、所采用的路由选择协议等），它使应用进程看见的就**好像是在两个运输层实体之间有一条端到端的逻辑通信信道。**

根据应用需求的不同，因特网的运输层为应用层提供了两种不同的运输层协议，即面向连接的TCP和无连接的UDP。

> 在网际层，网际层为主机提供逻辑通信服务，是一种尽最大努力的数据报服务，可能会出现各种错误，但是对于实时性要求高的服务，这是可以忽略的。
>
> 而对于电子邮件、文件传输等需要可靠传输通信的服务，需要使用TCP/ IP体系结构的运输层太提供可靠服务。

### 用户数据报协议 UDP

用户数据报协议(User Datagram Protocol,UDP)为其上层提供的是**无连接**的**不可靠**的数据传输服务。

使用UDP通信的双方，在传送数据之前不需要建立连接。

UDP不需要实现可靠传输，因此不需要使用实现可靠传输的各种机制。

UDP的实现简单，UDP用户数据报的首部比较小。

### 传输控制协议 TCP

传输控制协议(Transmission Control Protocol,,TCP)为其上层提供的是**面向连接**的**可靠**的数据传输服务。

使用TCP通信的双方，在传送数据之前必须首先**建立TCP连接**(逻辑连接，而非物理连接)。数据传输结束后必须要**释放TCP连接**。

TCP为了实现可靠传输，就必须使用很多措施，例如TCP连接管理、确认机制、超时重传、流量控制以及拥塞控制等。

TCP的实现复杂，TCP报文段的首部比较大，占用处理机资源比较多。

### 运输层端口号

运行在计算机上的进程是使用进程标识符（Process Identification，PID）来标识的。

TCP/IP体系结构的运输层使用端口号来标识和区分应用层的不同应用进程。端口号的长度为16比特，取值范围是0~65535。

**熟知端口号**

![image-20221106161553455](http://pic.shixiaocaia.fun/202211061616500.png)

> 端口号只具有本地意义，即端口号只是为了标识本计算机网络协议栈应用层中的各应用进程。在因特网中，不同计算机中的相同端口号是没有关系的，即相互独立。另外，TCP和UDP端口号之间也是没有关系的。

**发送方的复用和接收方的分用**

发送方的某些应用进程所发送的不同应用报文，在运输层使用UDP协议进行封装，称为UDP复用，在运输层使用TCP协议进行封装，称为TCP复用。

到网际层都需要使用IP协议封装成IP数据报，称为IP复用。在IP数据报中协议字段来表示封装的是何种协议数据单元。

---

接收端的网际层收到IP数据报进行IP分用。协议字段是17（UDP用户数据报），交给运输层的UDP，同样是TCP交给TCP处理。

运输层堆UDP用户数据报进行UDP分用，对TCP报文段进行TCP分用。根据其中的目的端口号，向上交付给应用层的相应进程。

## UDP和TCP的对比

**连接**

UDP不需要建立连接，可以随时进行通信。

TCP需要三次报文握手建立TCP连接，基础TCP连接进行数据传输，结束再通过四报文挥手释放TCP连接。

**单播、多播、组播**

显然UDP可以支持三种传播方式，而TCP需要建立连接，只能单播。

**对应用层报文处理**

UDP是面向应用报文的，对应用层发下来的报文加一个UDP首部后，使之成为UDP用户数据报，进行发送。

接受方收到后去除UDP首部，然后向上发给应用层。

TCP处理应用层报文，是看作一连串的、无结构的字节流，当发送缓存到一定数量的字节，构建TCP报文段进行发送。

TCP面向字节流，有利于实现可靠传输、流量控制和拥塞控制。

并且TCP连接是全双工通信的。

**对数据可靠性的支持**

UDP用户数据报出现的误码和丢失问题，接收端只是丢弃，不做任何处理，UDP适合用于实时应用。

TCP提供面向连接的可靠服务，尽管在一起使用的IP提供是无连接不可靠的，但是运输层使用TCP协议会保证这个。

**首部对比**

<img src="http://pic.shixiaocaia.fun/202211071648894.png" alt="image-20221107164751294" style="zoom:50%;" />

UDP首部十分简单，只加了用于区分应用进程的端口。

UDP在计算校验和时需要增加12字节的伪首部。

## TCP

<img src="http://pic.shixiaocaia.fun/202211071706177.png" alt="image-20221107170614878" style="zoom:50%;" />                                                                                                                                                                                                                                                                                                                                                                                                       

**序号、确认号、确认标志位ACK**

> 序号: 
>
> 用来指出本TCP报文段数据载荷的第一个字节的序号。
>
> 确认号:
>
> 用来指出期望收到对方下一个TCP报文段的数据载荷的第一个字节的序号，同时也是对之前收到的所有数据的确认。
>
> ACK:
>
> 只有当ACK取值为1时，确认号字段才有效。ACK取值为0时，确认号字段无效。
> TCP规定：在TCP连接建立后，所有传送的TCP报文段都必须把ACK置1。

**数字偏移字段**

> 指出TCP报文段的数据载荷部分的起始处距离TCP报文段的起始处有多远，这实际上指出了TCP报文段的首部长度。

**保留**

>  保留为今后使用，目前应置为0。

**窗口**

> 指出发送本报文段的一方的接收窗口的大小，即接收缓存的可用空间大小，这用来表征接收方的接收能力。
> 在计算机网络中，经常用**接收方的接收能力**的大小来控制发送方的数据发送量，这就是所谓的流量控制。

**校验和**

> 用来检查整个TCP报文段在传输过程中是否出现了误码。
>
> 与UDP相似的是，在计算校验和时，要在TCP报文段的前面加上12字节的伪首部。

**同步标志位SYN**

> 用于TCP“三报文握手”建立连接。
> 当SYN=1且ACK=0时，表明这是一个TCP连接请求报文段。
> 对方若同意建立连接，则应在响应的TCP报文段的首部中使SYN=1且ACK=1。
> 综上所述，SYN为1的TCP报文段要么是一个连接请求报文段，要么是一个连接响应报文段。

**终止标志位FIN**

> 用于TCP“四报文挥手”释放连接。
> 当FIN=1时，表明此TCP报文段的发送方已经将全部数据发送完毕，现在要求释放TCP连接。

**复位标志位RST**

> 用于复位TCP连接。
> 当RST=1时，表明TCP连接中出现严重差错，必须释放连接，然后再重新建立连接。
> RST置1还用来拒绝一个非法的TCP报文段或拒绝打开一个TCP连接。

**推送标志位PSH**

> 处于效率发送方会延迟发送，接收方会延迟向应用进程交付数据，来一次性处理数据。但有时候又要即可发送和处理。

> 发送方TCP把PSH置1，并立即创建一个TCP报文段发送出去，而不需要积累到足够多的数据再发送。
> 接收方TCP收到PSH为1的TCP报文段，就尽快地交付给应用进程，而不再等到接收到足够多的数据才向上交付。

**紧急指针**

> 当URG=1时，紧急指针字段有效，当URG=0时，紧急指针字段无效。
>
> 用来指明紧急数据的长度。
>
> 当**发送方有紧急数据**时，可将紧急数据“插队”到发送缓存的最前面，并立刻封装到一个TCP报文段中进行发送。紧急指针会指出本报文段数据载荷部分包含了多长的紧急数据，**紧急数据之后是普通数据**。
> 接收方收到紧急标志位为1的TCP报文段，会按照紧急指针字段的值从报文段数据载荷中取出紧急数据并直接上交应用进程，而不必在接收缓存中排队。

**选项**

> 扩充功能部分：
>
> 最大报文段长度MSS选项：指出TCP报文段数据载荷部分的最大长度，而不是整个TCP报文段的长度。
> 窗口扩大选项：用来扩大窗口，提高吞吐率。
>
> 选择确认选项：用来实现选择确认功能。
>
> 时间戳选项：
>
> - 用于计算往返时间RTT
> - 用于处理序号超范围的情况，又称为防止序号绕回PAWS。

**填充**

> 由于选项字段的长度是可变的，若选项字段的长度加上20字节固定首部的长度不能被4字节整除时，需要填充相应数量的比特0，以确保首部长度能被4字节整除。
